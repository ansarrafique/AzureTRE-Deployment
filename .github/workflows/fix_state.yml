name: "Surgical State Fix"

on:
  workflow_dispatch: # Allows you to trigger this manually from the Actions tab

jobs:
  repair:
    # Explicitly using your environment name
    environment: CICD
    runs-on: ubuntu-latest
    
    # Required for OIDC/Federated Credential authentication
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout Wrapper Repo
        uses: actions/checkout@v4

      - name: Clone Upstream AzureTRE
        run: |
          # Mimicking your devcontainer: Fetching the actual Terraform code
          git clone --branch v0.25.0 https://github.com/ansarrafique/AzureTRE.git AzureTRE
      
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          environment: ${{ (vars.AZURE_ENVIRONMENT != '' && vars.AZURE_ENVIRONMENT) || 'AzureCloud' }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Bypass Firewall & Run Fix
        run: |
          # 1. Get the Runner's Public IP
          RUNNER_IP=$(curl -s https://api.ipify.org)
          echo "Runner IP is: $RUNNER_IP"

          # 2. Add IP to Storage Firewall
          echo "Whitelisting Runner IP in storage firewall..."
          az storage account network-rule add \
            --resource-group oxdsh_mgmt \
            --account-name oxdshstg \
            --ip-address $RUNNER_IP

          # 3. Ensure Data Plane role is present (Object ID from previous step)
          SP_OBJECT_ID=$(az ad sp show --id ${{ secrets.AZURE_CLIENT_ID }} --query id --output tsv)
          az role assignment create \
            --role "Storage Blob Data Contributor" \
            --assignee "$SP_OBJECT_ID" \
            --scope "/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/oxdsh_mgmt/providers/Microsoft.Storage/storageAccounts/oxdshstg" || true

          # 4. Wait for propagation (Firewall updates can take ~30-60 seconds)
          echo "Waiting 60s for firewall propagation..."
          sleep 60

          # 5. Run Terraform commands
          cd AzureTRE/core/terraform
          terraform init \
            -backend-config="resource_group_name=oxdsh_mgmt" \
            -backend-config="storage_account_name=oxdshstg" \
            -backend-config="container_name=tfstate" \
            -backend-config="key=core.terraform.tfstate" \
            -backend-config="use_azuread_auth=true"

          terraform state rm -lock=false azurerm_subnet_route_table_association.rt_shared_subnet_association || true
          terraform state rm -lock=false azurerm_subnet_route_table_association.rt_resource_processor_subnet_association || true
          terraform state rm -lock=false azurerm_subnet_route_table_association.rt_web_app_subnet_association || true
          terraform state rm -lock=false azurerm_subnet_route_table_association.rt_airlock_processor_subnet_association || true
          terraform state rm -lock=false azurerm_subnet_route_table_association.rt_airlock_storage_subnet_association || true
          terraform state rm -lock=false azurerm_subnet_route_table_association.rt_airlock_events_subnet_association || true
          terraform state rm -lock=false module.network.azurerm_route_table.rt || true

          # 6. Cleanup (Remove IP from firewall)
          echo "Cleaning up firewall rule..."
          az storage account network-rule remove \
            --resource-group oxdsh_mgmt \
            --account-name oxdshstg \
            --ip-address $RUNNER_IP
