name: "Surgical State Fix"

on:
  workflow_dispatch: # Allows you to trigger this manually from the Actions tab

jobs:
  repair:
    # Explicitly using your environment name
    environment: CICD
    runs-on: ubuntu-latest
    
    # Required for OIDC/Federated Credential authentication
    permissions:
      id-token: write
      contents: read

    steps:
      - uses: actions/checkout@v4
      
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          environment: ${{ (vars.AZURE_ENVIRONMENT != '' && vars.AZURE_ENVIRONMENT) || 'AzureCloud' }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init and Fix
        run: |
          # 1. Navigate to the nested directory
          # Checking if AzureTRE folder exists, then moving in
          if [ -d "$GITHUB_WORKSPACE/AzureTRE/core/terraform" ]; then
            cd $GITHUB_WORKSPACE/AzureTRE/core/terraform
          elif [ -d "$GITHUB_WORKSPACE/core/terraform" ]; then
            cd $GITHUB_WORKSPACE/core/terraform
          else
            echo "Path not found. Listing root directory to find the right path:"
            ls -R $GITHUB_WORKSPACE
            exit 1
          fi
          
          echo "Current directory is: $(pwd)"
          
          # 2. Initialize with the Azure Backend
          terraform init \
            -backend-config="resource_group_name=oxdsh_mgmt" \
            -backend-config="storage_account_name=oxdshstg" \
            -backend-config="container_name=tfstate" \
            -backend-config="key=core.terraform.tfstate" \
            -backend-config="use_azuread_auth=true"

          # 3. Surgical State Removal
          # Using -lock=false to bypass any 'Lease' locks from previous failed runs
          terraform state rm -lock=false azurerm_subnet_route_table_association.rt_shared_subnet_association || true
          terraform state rm -lock=false azurerm_subnet_route_table_association.rt_resource_processor_subnet_association || true
          terraform state rm -lock=false azurerm_subnet_route_table_association.rt_web_app_subnet_association || true
          terraform state rm -lock=false azurerm_subnet_route_table_association.rt_airlock_processor_subnet_association || true
          terraform state rm -lock=false azurerm_subnet_route_table_association.rt_airlock_storage_subnet_association || true
          terraform state rm -lock=false azurerm_subnet_route_table_association.rt_airlock_events_subnet_association || true
          terraform state rm -lock=false module.network.azurerm_route_table.rt || true
