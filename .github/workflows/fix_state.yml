name: "Surgical State Fix"

on:
  workflow_dispatch:

jobs:
  repair:
    environment: CICD
    runs-on: ubuntu-latest
    
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout Wrapper Repo
        uses: actions/checkout@v4

      - name: Clone Upstream AzureTRE
        run: |
          git clone --branch v0.25.0 https://github.com/ansarrafique/AzureTRE.git AzureTRE
      
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Bypass Firewall & Run Fix
        run: |
          # 1. Enable Public Network Access
          echo "Enabling Public Network Access..."
          az storage account update \
            --resource-group oxdsh_mgmt \
            --name oxdshstg \
            --public-network-access Enabled

          # 2. Add Runner IP to Firewall
          RUNNER_IP=$(curl -s https://api.ipify.org)
          echo "Whitelisting Runner IP: $RUNNER_IP"
          az storage account network-rule add \
            --resource-group oxdsh_mgmt \
            --account-name oxdshstg \
            --ip-address $RUNNER_IP

          echo "Waiting 60s for network propagation..."
          sleep 60

          # 3. Run Terraform Fix
          cd AzureTRE/core/terraform
          terraform init \
            -backend-config="resource_group_name=oxdsh_mgmt" \
            -backend-config="storage_account_name=oxdshstg" \
            -backend-config="container_name=tfstate" \
            -backend-config="key=core.terraform.tfstate" \
            -backend-config="use_azuread_auth=true"

          echo "--- Current State (Route Table related) ---"
          terraform state list | grep 'rt' || echo "No matching resources found."

          # 4. Robust Removal Loop
          # We check if each resource exists before attempting to remove it to avoid 'Invalid target' errors
          RESOURCES=(
            "azurerm_subnet_route_table_association.rt_shared_subnet_association"
            "azurerm_subnet_route_table_association.rt_resource_processor_subnet_association"
            "azurerm_subnet_route_table_association.rt_web_app_subnet_association"
            "azurerm_subnet_route_table_association.rt_airlock_processor_subnet_association"
            "azurerm_subnet_route_table_association.rt_airlock_storage_subnet_association"
            "azurerm_subnet_route_table_association.rt_airlock_events_subnet_association"
            "module.network.azurerm_route_table.rt"
          )

          for res in "${RESOURCES[@]}"; do
            if terraform state list | grep -q "$res"; then
              echo "Removing $res..."
              terraform state rm -lock=false "$res" || true
            else
              echo "Skipping $res: Not found in state."
            fi
          done

          # 5. RESTORE SECURITY
          echo "Restoring security settings..."
          az storage account network-rule remove \
            --resource-group oxdsh_mgmt \
            --account-name oxdshstg \
            --ip-address $RUNNER_IP
          
          az storage account update \
            --resource-group oxdsh_mgmt \
            --name oxdshstg \
            --public-network-access Disabled
